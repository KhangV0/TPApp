@model List<TPApp.Entities.ProjectStep>

@{
    ViewData["Title"] = "Tiến độ dự án";
    int projectId = ViewBag.ProjectId;
}

<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2>@ViewData["Title"] <small class="text-muted">@ViewBag.ProjectName</small></h2>
        <a asp-action="Details" asp-controller="Project" asp-route-id="@projectId" class="btn btn-secondary">
            <i class="bi bi-arrow-left"></i> Quay lại Dự án
        </a>
    </div>

    <div class="card shadow-sm">
        <div class="card-header bg-primary text-white">
            <h5 class="mb-0">Quy trình Chuyển giao Công nghệ (11 Bước)</h5>
        </div>
        <div class="list-group list-group-flush">
            @foreach (var step in Model)
            {
                string statusClass = "";
                string statusText = "";
                string actionLink = "#";
                bool isClickable = false;

                switch (step.StatusId)
                {
                    case 0: // Not Started
                        statusClass = "badge bg-secondary";
                        statusText = "Chưa bắt đầu";
                        isClickable = false;
                        break;
                    case 1: // In Progress
                        statusClass = "badge bg-warning text-dark";
                        statusText = "Đang thực hiện";
                        isClickable = true;
                        break;
                    case 2: // Completed
                        statusClass = "badge bg-success";
                        statusText = "Hoàn thành";
                        isClickable = true; // Review allowed
                        break;
                }

                // Define Action Links based on Step Number
                if (isClickable || step.StatusId == 2) 
                {
                     switch (step.StepNumber)
                    {
                        case 1: actionLink = Url.Action("Details", "TechTransfer", new { projectId = projectId }); break; // Or Edit?
                        case 2: actionLink = Url.Action("Create", "NDA", new { projectId = projectId }); break;
                        case 3: actionLink = Url.Action("Create", "RFQ", new { projectId = projectId }); break;
                        case 4: actionLink = Url.Action("Index", "Proposal", new { duAnId = projectId }); break; // Proposal List
                        case 5: actionLink = Url.Action("Create", "Negotiation", new { projectId = projectId }); break;
                        case 6: actionLink = Url.Action("Create", "EContract", new { projectId = projectId }); break;
                        case 7: actionLink = Url.Action("Create", "AdvancePayment", new { projectId = projectId }); break;
                        case 8: actionLink = Url.Action("Create", "ImplementationLog", new { projectId = projectId }); break;
                        case 9: actionLink = Url.Action("Create", "Handover", new { projectId = projectId }); break;
                        case 10: actionLink = Url.Action("Create", "Acceptance", new { projectId = projectId }); break;
                        case 11: actionLink = Url.Action("Create", "Liquidation", new { projectId = projectId }); break;
                    }
                }
               

                <a href="@(isClickable ? actionLink : "#")" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center @(isClickable ? "" : "disabled")">
                    <div>
                        <span class="fw-bold me-2">Bước @step.StepNumber:</span>
                        <span>@step.StepName</span>
                        @if (step.CompletedDate.HasValue)
                        {
                            <small class="text-muted d-block">Hoàn thành: @step.CompletedDate.Value.ToString("dd/MM/yyyy HH:mm")</small>
                        }
                    </div>
                    <span class="@statusClass rounded-pill">@statusText</span>
                </a>
            }
        </div>
    </div>
</div>
