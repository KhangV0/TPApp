@model TPApp.ViewModel.ProjectDetailWithStepsVm

@{
    ViewData["Title"] = "Chi tiết dự án: " + Model.Project.ProjectName;
}

<div class="container-fluid py-4">
    <!-- Project Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2>@Model.Project.ProjectName</h2>
            <p class="text-muted mb-0">
                <i class="fas fa-code"></i> @Model.Project.ProjectCode
            </p>
        </div>
        <div>
            <span class="badge bg-secondary fs-6">
                <i class="fas fa-user"></i> 
                @(Model.UserRole == 1 ? "Buyer" : Model.UserRole == 2 ? "Seller" : "Consultant")
            </span>
        </div>
    </div>

    <!-- Horizontal Step Navigation -->
    @await Html.PartialAsync("_ProjectStepsNav", Model.Steps)

    <!-- Dynamic Step Content Container -->
    <div id="step-content">
        @await Html.PartialAsync($"Steps/_Step{Model.CurrentStep}", new TPApp.ViewModel.StepContentVm 
        { 
            ProjectId = Model.Project.Id,
            StepNumber = Model.CurrentStep,
            StepName = Model.Steps[Model.CurrentStep - 1].StepName,
            Project = Model.Project,
            UserRole = Model.UserRole,
            Steps = Model.Steps,
            CurrentStep = Model.CurrentStep
        })
    </div>
</div>

@section Scripts {
    <script>
        $(document).ready(function() {
            // Handle step navigation clicks
            $(document).on('click', '.step-link', function(e) {
                e.preventDefault();
                
                var step = $(this).data('step');
                var projectId = @Model.Project.Id;
                
                // Show loading
                $('#step-content').html('<div class="text-center p-5"><i class="fas fa-spinner fa-spin fa-3x text-primary"></i><p class="mt-3">Đang tải...</p></div>');
                
                // Load step content via AJAX
                $.get('/Project/Step', { projectId: projectId, stepNumber: step }, function(data) {
                    $('#step-content').html(data);
                    
                    // Update active state in navigation
                    $('.step-item .nav-link').removeClass('active');
                    $(`.step-link[data-step="${step}"]`).closest('.nav-link').addClass('active');
                    
                    // Scroll to top of content
                    $('html, body').animate({
                        scrollTop: $('#step-content').offset().top - 100
                    }, 300);
                }).fail(function() {
                    $('#step-content').html('<div class="alert alert-danger"><i class="fas fa-exclamation-triangle"></i> Lỗi tải nội dung. Vui lòng thử lại.</div>');
                });
            });
            
            // Handle next/prev buttons in step content
            $(document).on('click', '.step-nav-btn', function(e) {
                e.preventDefault();
                var step = $(this).data('step');
                $(`.step-link[data-step="${step}"]`).click();
            });
        });
    </script>
}
