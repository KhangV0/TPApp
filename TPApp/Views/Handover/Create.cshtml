@model TPApp.Entities.HandoverReport

@{
    ViewData["Title"] = "BIÊN BẢN BÀN GIAO";
}

<div class="container mt-5 mb-5">
    <div class="card shadow">
        <div class="card-header bg-primary text-white">
            <h2 class="h4 mb-0"><i class="fas fa-handshake me-2"></i>@ViewData["Title"]</h2>
        </div>
        <div class="card-body">
            <form asp-action="Create" method="post" id="handoverForm">
                @Html.AntiForgeryToken()
                <div asp-validation-summary="ModelOnly" class="alert alert-danger" role="alert"></div>

                <div class="row g-3 mb-4">
                    <div class="col-md-6">
                        <label asp-for="DuAnId" class="form-label">Dự án ID</label>
                        <input asp-for="DuAnId" class="form-control" type="number" placeholder="Nhập ID dự án" />
                        <span asp-validation-for="DuAnId" class="text-danger"></span>
                    </div>

                    <div class="col-md-6">
                        <label asp-for="EContractId" class="form-label">E-Contract ID</label>
                        <input asp-for="EContractId" class="form-control" type="number" placeholder="Nhập ID hợp đồng" />
                        <span asp-validation-for="EContractId" class="text-danger"></span>
                    </div>
                </div>

                <!-- SECTION 1: Equipment List -->
                <h5 class="border-bottom pb-2 mb-3">I. Danh mục thiết bị bàn giao</h5>
                <div class="table-responsive mb-3">
                    <table class="table table-bordered" id="equipmentTable">
                        <thead class="table-light">
                            <tr>
                                <th>Tên thiết bị</th>
                                <th>Model</th>
                                <th>Serial</th>
                                <th>Tình trạng</th>
                                <th style="width: 50px;"></th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Rows will be added here -->
                        </tbody>
                    </table>
                </div>
                <button type="button" class="btn btn-outline-primary btn-sm mb-4" onclick="addEquipmentRow()">
                    <i class="fas fa-plus me-1"></i>Thêm thiết bị
                </button>
                <input type="hidden" name="DanhMucThietBiJson" id="DanhMucThietBiJson" />

                <!-- SECTION 2: Checklist -->
                <h5 class="border-bottom pb-2 mb-3">II. Danh mục hồ sơ bàn giao</h5>
                <div class="row g-3 mb-4">
                    <div class="col-md-4">
                        <div class="form-check">
                            <input class="form-check-input checklist-item" type="checkbox" value="CO/CQ" id="check1">
                            <label class="form-check-label" for="check1">CO/CQ</label>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="form-check">
                            <input class="form-check-input checklist-item" type="checkbox" value="Hướng dẫn sử dụng" id="check2">
                            <label class="form-check-label" for="check2">Hướng dẫn sử dụng</label>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="form-check">
                            <input class="form-check-input checklist-item" type="checkbox" value="Bản vẽ kỹ thuật" id="check3">
                            <label class="form-check-label" for="check3">Bản vẽ kỹ thuật</label>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="form-check">
                            <input class="form-check-input checklist-item" type="checkbox" value="Biên bản nghiệm thu" id="check4">
                            <label class="form-check-label" for="check4">Biên bản nghiệm thu</label>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="form-check">
                            <input class="form-check-input checklist-item" type="checkbox" value="Tài liệu đào tạo" id="check5">
                            <label class="form-check-label" for="check5">Tài liệu đào tạo</label>
                        </div>
                    </div>
                </div>
                <input type="hidden" name="DanhMucHoSoJson" id="DanhMucHoSoJson" />

                <!-- SECTION 3: Training -->
                <h5 class="border-bottom pb-2 mb-3">III. Xác nhận đào tạo</h5>
                <div class="form-check mb-4">
                    <input asp-for="DaHoanThanhDaoTao" class="form-check-input" type="checkbox" />
                    <label asp-for="DaHoanThanhDaoTao" class="form-check-label">
                        Đã hoàn thành hướng dẫn vận hành và đào tạo cho người sử dụng
                    </label>
                </div>

                <!-- SECTION 4: Rating -->
                <h5 class="border-bottom pb-2 mb-3">IV. Đánh giá & Nhận xét</h5>
                <div class="mb-3">
                    <label class="form-label">Đánh giá mức độ hài lòng:</label>
                    <div class="rating">
                        <input type="range" class="form-range" min="1" max="5" step="1" asp-for="DanhGiaSao" oninput="updateRatingDisplay(this.value)">
                        <div class="text-center fw-bold text-warning fs-4">
                            <span id="ratingDisplay">5</span> <i class="fas fa-star"></i>
                        </div>
                    </div>
                </div>
                <div class="mb-3">
                    <label asp-for="NhanXet" class="form-label">Nhận xét khác</label>
                    <textarea asp-for="NhanXet" class="form-control" rows="3" placeholder="Nhập ý kiến đóng góp..."></textarea>
                    <span asp-validation-for="NhanXet" class="text-danger"></span>
                </div>

                <div class="d-grid gap-2 d-md-flex justify-content-md-end mt-4">
                    <a asp-controller="Home" asp-action="Index" class="btn btn-secondary me-md-2">Hủy bỏ</a>
                    <button type="submit" class="btn btn-primary" onclick="prepareSubmission()"><i class="fas fa-save me-2"></i>Lưu biên bản bàn giao</button>
                </div>
            </form>
        </div>
    </div>
</div>

@section Scripts {
    @{await Html.RenderPartialAsync("_ValidationScriptsPartial");}
    <script>
        function updateRatingDisplay(val) {
            document.getElementById('ratingDisplay').innerText = val;
        }

        function addEquipmentRow() {
            var table = document.getElementById("equipmentTable").getElementsByTagName('tbody')[0];
            var row = table.insertRow();
            row.innerHTML = `
                <td><input type="text" class="form-control eq-name" placeholder="Tên thiết bị"></td>
                <td><input type="text" class="form-control eq-model" placeholder="Model"></td>
                <td><input type="text" class="form-control eq-serial" placeholder="Serial"></td>
                <td><input type="text" class="form-control eq-condition" placeholder="Tình trạng"></td>
                <td class="text-center"><button type="button" class="btn btn-outline-danger btn-sm" onclick="this.closest('tr').remove()"><i class="fas fa-trash"></i></button></td>
            `;
        }

        function prepareSubmission() {
            // Serialize Equipment Table
            var equipment = [];
            var rows = document.querySelectorAll("#equipmentTable tbody tr");
            rows.forEach(row => {
                var item = {
                    Ten: row.querySelector(".eq-name").value,
                    Model: row.querySelector(".eq-model").value,
                    Serial: row.querySelector(".eq-serial").value,
                    TinhTrang: row.querySelector(".eq-condition").value
                };
                if(item.Ten) equipment.push(item);
            });
            document.getElementById("DanhMucThietBiJson").value = JSON.stringify(equipment);

            // Serialize Checklist
            var checklist = [];
            document.querySelectorAll(".checklist-item:checked").forEach(cb => {
                checklist.push(cb.value);
            });
            document.getElementById("DanhMucHoSoJson").value = JSON.stringify(checklist);
        }

        // Initialize with one row
        window.onload = function() {
           if(document.querySelectorAll("#equipmentTable tbody tr").length === 0) {
               addEquipmentRow();
           }
        };
    </script>
}
